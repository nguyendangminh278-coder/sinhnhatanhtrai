<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Scene - Signature & Camera</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }

        .final-scene {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Hai ảnh nền 21 (đóng) & 22 (mở) */
        .letter-img {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #closedLetter {
            z-index: 1;
            opacity: 1;
            cursor: pointer;
            transition: opacity 0.6s ease;
        }

        #closedLetter.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #openLetter {
            z-index: 0;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        #openLetter.visible {
            opacity: 1;
        }

        /* Canvas ký tên (trong suốt, nằm trên vùng giấy) */
        #signCanvas {
            position: absolute;
            top: 56%;
            left: 50%;
            width: 38%;
            height: 30%;
            transform: translate(-50%, -50%);
            z-index: 2;
            pointer-events: none;
            background: transparent;
        }

        /* Nút ngọn hải đăng trên con dấu */
        #sealButton {
            position: absolute;
            /* trước là 78% + 30px, giờ xuống thêm 10px */
            top: calc(78% + 48px);
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            border: none;
            padding: 0;
            background: transparent;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease;
        }

        #sealButton.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #sealButton img {
            display: block;
            width: 180px;   /* TO HƠN một chút */
            height: auto;
            filter:
                drop-shadow(0 0 10px rgba(255, 240, 200, 0.9))
                drop-shadow(0 0 22px rgba(120, 170, 255, 0.9));
            animation: glowPulse 2.1s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% {
                filter:
                    drop-shadow(0 0 10px rgba(255, 240, 200, 0.9))
                    drop-shadow(0 0 22px rgba(120, 170, 255, 0.9));
            }
            50% {
                filter:
                    drop-shadow(0 0 18px rgba(255, 255, 220, 1))
                    drop-shadow(0 0 38px rgba(150, 200, 255, 1));
            }
        }

        /* Video final full màn hình */
        #finalVideo {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 10;
            display: none;
            background: #000;
        }

        /* Màn camera: dùng ảnh final001.png làm nền */
        #cameraStage {
            position: fixed;
            inset: 0;
            z-index: 11;
            display: none;
            background:
                #000
                url("https://raw.githubusercontent.com/nguyendangminh278-coder/sinhnhatanhtrai/2d242807735e20e1bed67bde87a032f13a4bf149/Project%20SN%20AL/final001.png")
                center center / cover
                no-repeat;
        }

        /* KHUNG CAMERA – căn cho trùng khung chữ nhật ở giữa ảnh
           (không còn viền trắng) */
        #cameraVideo {
    position: absolute;
    top: 60%;       /* giữ giữa */
    left: 50%;
    width: 52%;     /* phủ gần hết phần khung xám */
    height: 60%;    /* thấp hơn để vừa khung */
    transform: translate(-50%, -50%);
    border-radius: 32px;
    border: none;
    box-shadow: none;
    background: #000;
    object-fit: cover;
}

    </style>
</head>
<body>
    <div class="final-scene">
        <!-- Ảnh 21: thư đóng -->
        <img
            id="closedLetter"
            class="letter-img"
            src="https://raw.githubusercontent.com/nguyendangminh278-coder/sinhnhatanhtrai/ae518182aaec7be167c5b1cc719a8a935eaefdcc/Project%20SN%20AL/m%E1%BB%9F%20b%E1%BB%A9c%20th%C6%B0/21.png"
            alt="Closed Letter">

        <!-- Ảnh 22: thư mở -->
        <img
            id="openLetter"
            class="letter-img"
            src="https://raw.githubusercontent.com/nguyendangminh278-coder/sinhnhatanhtrai/ae518182aaec7be167c5b1cc719a8a935eaefdcc/Project%20SN%20AL/m%E1%BB%9F%20b%E1%BB%A9c%20th%C6%B0/22.png"
            alt="Open Letter">

        <!-- Canvas để ký -->
        <canvas id="signCanvas"></canvas>

        <!-- Nút ngọn hải đăng trên con dấu -->
        <button id="sealButton">
            <img
                src="https://raw.githubusercontent.com/nguyendangminh278-coder/sinhnhatanhtrai/e1e1871aeee8d85d0424e9326693936e375cf020/Project%20SN%20AL/%E7%81%AF%E5%A1%94%E4%B9%8B%E5%85%89.png"
                alt="Continue Button">
        </button>

        <!-- Video final -->
        <video id="finalVideo" preload="auto">
            <source src="https://raw.githubusercontent.com/nguyendangminh278-coder/sinhnhatanhtrai/ca2bc283bceb680c768f0fae057044805fd86178/Project%20SN%20AL/Finnal.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <!-- Màn camera + layer nền final001.png -->
        <div id="cameraStage">
            <video id="cameraVideo" autoplay playsinline></video>
        </div>
    </div>

    <script>
        const closedLetter  = document.getElementById('closedLetter');
        const openLetter    = document.getElementById('openLetter');
        const signCanvas    = document.getElementById('signCanvas');
        const ctx           = signCanvas.getContext('2d');

        const sealButton    = document.getElementById('sealButton');
        const finalVideo    = document.getElementById('finalVideo');
        const cameraStage   = document.getElementById('cameraStage');
        const cameraVideo   = document.getElementById('cameraVideo');

        let drawing = false;
        let hasDrawn = false;
        let sealShown = false;

        function setupCanvas() {
            const rect  = signCanvas.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;

            signCanvas.width  = rect.width * scale;
            signCanvas.height = rect.height * scale;

            ctx.setTransform(scale, 0, 0, scale, 0, 0);
            ctx.lineCap   = 'round';
            ctx.lineJoin  = 'round';
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#1f3b75';
        }

        window.addEventListener('load', setupCanvas);
        window.addEventListener('resize', setupCanvas);

        function getPos(e) {
            const rect = signCanvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            } else {
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
        }

        function startDraw(e) {
            drawing = true;
            hasDrawn = true;
            const { x, y } = getPos(e);
            ctx.beginPath();
            ctx.moveTo(x, y);
            e.preventDefault();
        }

        function draw(e) {
            if (!drawing) return;
            const { x, y } = getPos(e);
            ctx.lineTo(x, y);
            ctx.stroke();
            e.preventDefault();
        }

        function endDraw(e) {
            if (!drawing) return;
            drawing = false;
            e.preventDefault();

            if (hasDrawn && !sealShown) {
                sealShown = true;
                sealButton.classList.add('visible');
            }
        }

        function openEnvelope() {
            closedLetter.classList.add('hidden');
            openLetter.classList.add('visible');
            signCanvas.style.pointerEvents = 'auto';
            setupCanvas();
        }

        closedLetter.addEventListener('click', openEnvelope);

        signCanvas.addEventListener('mousedown', startDraw);
        signCanvas.addEventListener('mousemove', draw);
        signCanvas.addEventListener('mouseup', endDraw);
        signCanvas.addEventListener('mouseleave', endDraw);

        signCanvas.addEventListener('touchstart', startDraw, { passive: false });
        signCanvas.addEventListener('touchmove', draw,        { passive: false });
        signCanvas.addEventListener('touchend',  endDraw,      { passive: false });
        signCanvas.addEventListener('touchcancel', endDraw,    { passive: false });

        function startFinalSequence() {
            closedLetter.style.display = 'none';
            openLetter.style.display   = 'none';
            signCanvas.style.display   = 'none';
            sealButton.style.display   = 'none';

            finalVideo.style.display = 'block';
            finalVideo.currentTime = 0;
            finalVideo.play().catch(err => {
                console.log('Video play error:', err);
            });
        }

        sealButton.addEventListener('click', startFinalSequence);

        finalVideo.addEventListener('ended', () => {
            finalVideo.style.display = 'none';
            cameraStage.style.display = 'block';

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices
                    .getUserMedia({ video: true, audio: false })
                    .then(stream => {
                        cameraVideo.srcObject = stream;
                    })
                    .catch(err => {
                        console.log('Cannot access camera:', err);
                    });
            } else {
                console.log('getUserMedia not supported on this browser.');
            }
        });
    </script>
</body>
</html>
